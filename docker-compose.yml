version: '3.8'

services:
  # Node 0 - Primary validator
  node0:
    build: .
    container_name: pbft-node0
    environment:
      - NODE_INDEX=0
      - NUM_NODES=4
      - P2P_PORT=9000
      - RPC_PORT=8545
      - CHAIN_ID=pbft-chain
      - INITIAL_BALANCE=1000000
      - RUST_LOG=info
    ports:
      - "9000:9000"   # P2P
      - "8545:8545"   # RPC
    volumes:
      - node0-data:/app/data
    networks:
      - pbft-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8545", "-X", "POST", "-H", "Content-Type: application/json", "-d", '{"jsonrpc":"2.0","method":"pbft_getStatus","params":[],"id":1}']
      interval: 10s
      timeout: 5s
      retries: 5

  # Node 1
  node1:
    build: .
    container_name: pbft-node1
    environment:
      - NODE_INDEX=1
      - NUM_NODES=4
      - P2P_PORT=9000
      - RPC_PORT=8545
      - CHAIN_ID=pbft-chain
      - INITIAL_BALANCE=1000000
      - BOOTSTRAP_NODES=node0:9000
      - RUST_LOG=info
    ports:
      - "9001:9000"   # P2P
      - "8546:8545"   # RPC
    volumes:
      - node1-data:/app/data
    networks:
      - pbft-network
    depends_on:
      node0:
        condition: service_started

  # Node 2
  node2:
    build: .
    container_name: pbft-node2
    environment:
      - NODE_INDEX=2
      - NUM_NODES=4
      - P2P_PORT=9000
      - RPC_PORT=8545
      - CHAIN_ID=pbft-chain
      - INITIAL_BALANCE=1000000
      - BOOTSTRAP_NODES=node0:9000 node1:9000
      - RUST_LOG=info
    ports:
      - "9002:9000"   # P2P
      - "8547:8545"   # RPC
    volumes:
      - node2-data:/app/data
    networks:
      - pbft-network
    depends_on:
      - node0
      - node1

  # Node 3
  node3:
    build: .
    container_name: pbft-node3
    environment:
      - NODE_INDEX=3
      - NUM_NODES=4
      - P2P_PORT=9000
      - RPC_PORT=8545
      - CHAIN_ID=pbft-chain
      - INITIAL_BALANCE=1000000
      - BOOTSTRAP_NODES=node0:9000 node1:9000 node2:9000
      - RUST_LOG=info
    ports:
      - "9003:9000"   # P2P
      - "8548:8545"   # RPC
    volumes:
      - node3-data:/app/data
    networks:
      - pbft-network
    depends_on:
      - node0
      - node1
      - node2

  # Frontend Explorer
  explorer:
    build: .
    container_name: pbft-explorer
    command: frontend
    ports:
      - "3000:3000"
    networks:
      - pbft-network
    depends_on:
      - node0

networks:
  pbft-network:
    driver: bridge

volumes:
  node0-data:
  node1-data:
  node2-data:
  node3-data:
